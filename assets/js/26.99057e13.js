(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{340:function(_,v,t){"use strict";t.r(v);var e=t(4),o=Object(e.a)({},(function(){var _=this,v=_.$createElement,t=_._self._c||v;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("h2",{attrs:{id:"背景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[_._v("#")]),_._v(" 背景")]),_._v(" "),t("p",[_._v("首页的文章列表如下图：")]),_._v(" "),t("img",{attrs:{src:"/img/work/首页文章.png",width:"300"}}),_._v(" "),t("p",[_._v("视频文章上线后，希望"),t("code",[_._v("视频类型")]),_._v("的文章，将封面图由静态JPG图转为动态的GIF图")]),_._v(" "),t("h2",{attrs:{id:"需求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#需求"}},[_._v("#")]),_._v(" 需求")]),_._v(" "),t("ul",[t("li",[_._v("视频文章发布后，自动生成GIF封面图。")]),_._v(" "),t("li",[_._v("首页接口返回的文章，如果是视频文章，并且生成了GIF图，就用GIF图作为封面。否则还是用JPG作为封面")])]),_._v(" "),t("h2",{attrs:{id:"思路和调研"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#思路和调研"}},[_._v("#")]),_._v(" 思路和调研")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("每发一篇文章就自动 "),t("code",[_._v("MP4")]),_._v("转"),t("code",[_._v("GIF")]),_._v("。")]),_._v(" "),t("blockquote",[t("p",[_._v("同步执行：")]),_._v(" "),t("p",[_._v("​\t\t生成GIF图片并且上传成功，才能返回发文章成功到客户端")]),_._v(" "),t("p",[_._v("​\t\t可能发生网络延迟或者突然宕机")]),_._v(" "),t("p",[_._v("决定将发文章和生成GIF图异步执行")])])]),_._v(" "),t("li",[t("p",[_._v("异步执行时，每发一篇文章就把文章id塞到队列中，再轮询或者监听队列")]),_._v(" "),t("blockquote",[t("p",[_._v("Redis中有blpop命令可以实现需求。list中有值时就pop出来。为空时就会阻塞")])])]),_._v(" "),t("li",[t("p",[_._v("视频生成GIF图片可以由ffmpeg实现。")]),_._v(" "),t("blockquote",[t("p",[_._v("基础命令为："),t("code",[_._v("ffmpeg -ss 0 -t 8 -i /video_path.mp4 -r 15 gif_path.gif")]),_._v("。")]),_._v(" "),t("p",[t("code",[_._v("-ss time off set the start time offset")])]),_._v(" "),t("p",[t("code",[_._v('-t duration record or transcode "duration" seconds of audio/video')])]),_._v(" "),t("p",[t("code",[_._v("-r rate set frame rate (Hz value, fraction or abbreviation)")])])])])]),_._v(" "),t("h2",{attrs:{id:"实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实现"}},[_._v("#")]),_._v(" 实现")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("表中添加字段"),t("code",[_._v("status")]),_._v("标志生成GIF图的状态。"),t("code",[_._v("0")]),_._v("表示未生成GIF图，"),t("code",[_._v("5")]),_._v("表示已生成GIF图。")]),_._v(" "),t("blockquote",[t("p",[_._v("间隔取大点，要是后期需要在两个状态中间再加状态，更方便维护")])])]),_._v(" "),t("li",[t("p",[_._v("PHP")]),_._v(" "),t("blockquote",[t("ol",[t("li",[_._v("文章id塞到队列")]),_._v(" "),t("li",[_._v("回调中修改状态，标志已生成GIF图。文章取封面时就可以直接根据状态字段获取")])])])]),_._v(" "),t("li",[t("p",[_._v("Go")]),_._v(" "),t("blockquote",[t("p",[_._v("生成GIF算是一个服务，尝试用Go，生成GIF图且上传成功之后，回调PHP")])])]),_._v(" "),t("li",[t("p",[_._v("Redis")]),_._v(" "),t("blockquote",[t("p",[_._v("上传成视频文章之后，将文章的id"),t("code",[_._v("rpush")]),_._v("到队列"),t("code",[_._v("video_url_list")]),_._v("中，"),t("code",[_._v("blpop")]),_._v("监听队列")]),_._v(" "),t("p",[_._v("为了让服Go服务中的代码相对简单。将回调地址和文章id合并成json塞到队列中（尽量做到单一职责）")]),_._v(" "),t("p",[t("code",[_._v("video_url_list")]),_._v(' 中每个元素为{"subject_id":1,"callback":"http://callback?subject_id=1"}')])])]),_._v(" "),t("li",[t("p",[_._v("ffmpeg")]),_._v(" "),t("blockquote",[t("p",[_._v("生成GIF图时，文件大小相对较小，质量相对高清的命令：")]),_._v(" "),t("p",[_._v('ffmpeg -filter_complex "[0:v] fps=12,scale=480:-1" -ss 0 -t 2 -i video.mp4 -loglevel quiet -hide_banner -stats -f gif -')])])])])])}),[],!1,null,null,null);v.default=o.exports}}]);