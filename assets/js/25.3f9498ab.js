(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{348:function(e,t,_){"use strict";_.r(t);var s=_(4),v=Object(s.a)({},(function(){var e=this,t=e.$createElement,_=e._self._c||t;return _("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[_("h2",{attrs:{id:"背景"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[e._v("#")]),e._v(" 背景")]),e._v(" "),_("p",[e._v("随着社区发展，用户对于浏览视频类型的文章（沉浸式阅读）的需求越来越来大，并且视频也能更直观得展示内容。")]),e._v(" "),_("h2",{attrs:{id:"需求"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#需求"}},[e._v("#")]),e._v(" 需求")]),e._v(" "),_("ul",[_("li",[e._v("用户点击视频类型的文章时，接口只返回视频文章")]),e._v(" "),_("li",[e._v("每个视频有分类，优先返回当前分类的文章")]),e._v(" "),_("li",[e._v("用户每次看到的视频不重复")])]),e._v(" "),_("h2",{attrs:{id:"思路"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#思路"}},[e._v("#")]),e._v(" 思路")]),e._v(" "),_("ul",[_("li",[_("p",[e._v("分类id 代码中为 category_id ；用户id为 user_id")])]),e._v(" "),_("li",[_("p",[e._v("期望不重复 => 需要记录下用户看过哪些视频")])]),e._v(" "),_("li",[_("p",[e._v("希望访问速度能快 => 考虑将用户看过的视频记录在redis中")])]),e._v(" "),_("li",[_("p",[e._v("文章的分类信息已经在 MySQL 中记录。将视频再记录到redis中")])]),e._v(" "),_("li",[_("p",[e._v("不同分类的文章可以用 redis 的"),_("code",[e._v("list")]),e._v("来存储 list:{category_id}")])]),e._v(" "),_("li",[_("p",[e._v("用户看视频的记录用redis 的zset来存储")]),e._v(" "),_("p",[e._v("​\t\t记录看到了 key_list 的哪个offset（只有这个需求的话，也可以不用zset，用hash）")]),e._v(" "),_("p",[e._v("​\t\t还需要当该分类看完时，找出未看完的分类，继续向后找。（将看完的置为负数之后，可以zrangebyscore找出没看完的）")])])]),e._v(" "),_("h2",{attrs:{id:"实现"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#实现"}},[e._v("#")]),e._v(" 实现")]),e._v(" "),_("ul",[_("li",[e._v("设计两类 redis的key。一个是视频的"),_("code",[e._v("list")]),e._v("，一个category_id 的"),_("code",[e._v("zset")]),e._v("，每发一篇视频文章就往对应的"),_("code",[e._v("list:{category_id}")]),e._v("中 push 文章id；另一个是 user_id 的"),_("code",[e._v("zset")]),e._v("，"),_("code",[e._v("member")]),e._v(" 为 category_id, "),_("code",[e._v("score")]),e._v(" 为 用户看过的 "),_("code",[e._v("list:{category_id}")]),e._v(" 的 offset。用户每次请求视频文章接口，先拿offset，再"),_("code",[e._v("lrange key offset expectCount")])]),e._v(" "),_("li",[e._v("用户每次请求接口，从redis 的 "),_("code",[e._v("list:{category_id}")]),e._v("中取出10个，并且记录下用户看到了哪里（offset），已看完的置为负数。（没有取够10个时，用zrangebyscore找出未看完的offset最小那个category_id，"),_("code",[e._v("递归")]),e._v("继续取。如果全部取完了。就将所有category_id的"),_("code",[e._v("zset")]),e._v("重置回初始状态）")])])])}),[],!1,null,null,null);t.default=v.exports}}]);