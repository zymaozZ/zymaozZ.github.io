(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{342:function(s,n,a){"use strict";a.r(n);var t=a(4),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"持久化方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#持久化方式"}},[s._v("#")]),s._v(" 持久化方式")]),s._v(" "),a("ul",[a("li",[s._v("快照（snapshotting）将存在于某一时刻的数据全部写进磁盘")]),s._v(" "),a("li",[s._v("append-only-file（AOF）执行写命令时，将命令复制到硬盘中")])]),s._v(" "),a("blockquote",[a("p",[s._v("这两种方法可以同时使用也可以单独使用")])]),s._v(" "),a("h2",{attrs:{id:"rdb-snapshotting"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rdb-snapshotting"}},[s._v("#")]),s._v(" RDB (snapshotting)")]),s._v(" "),a("p",[a("code",[s._v("redis.conf")]),s._v("中相关的配置如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置规则：save <seconds> <changes>")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当下列任一情况符合时，redis会进行持久化")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#\t若是想禁用snapshotting的持久化方式，可以按照如下配置：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#\tsave ""')]),s._v("\nsave "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("900")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# \t900 秒 中 1 \t\t个key发生了变化")]),s._v("\nsave "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   300 秒 中 10 \t\t个key发生了变化")]),s._v("\nsave "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v("\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   60 \t秒 中 10000 个key发生了变化")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启用了RDB snapshot，并且最近的 background save 失败，redis将停止写入操作")]),s._v("\nstop-writes-on-bgsave-error "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 转储.rdb数据库时使用LZF压缩")]),s._v("\nrdbcompression "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据校验（保存和加载RDB文件时会多消耗10%的资源）")]),s._v("\nrdbchecksum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 持久化的文件名")]),s._v("\ndbfilename dump.rdb\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 持久化文件存储路径")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /usr/local/var/db/redis/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[s._v("创建snapshotting的几种方式：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("客户端向"),a("code",[s._v("redis")]),s._v("发送"),a("code",[s._v("bgsave")]),s._v("命令（Redis会调用"),a("code",[s._v("fork")]),s._v("创建一个子进程，子进程负责将快照写入磁盘，父进程继续处理命令请求）")])]),s._v(" "),a("li",[a("p",[s._v("客户端向"),a("code",[s._v("redis")]),s._v("发送"),a("code",[s._v("save")]),s._v("命令来创建快照（还在当前进程中创建快照并写入磁盘，未处理完之前不会响应其他命令，因此不常用）")])]),s._v(" "),a("li",[a("p",[s._v("配置了"),a("code",[s._v("save 900 1")]),s._v("这种配置，满足条件之后就会自动触发"),a("code",[s._v("bgsave")]),s._v("命令")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Redis")]),s._v("通过"),a("code",[s._v("shutdown")]),s._v("命令接收到关闭服务器请求，或者接收到标准"),a("code",[s._v("term")]),s._v("信号时，会执行一个"),a("code",[s._v("save")]),s._v("命令，不再执行客户端发送的任何命令，并且在执行完"),a("code",[s._v("save")]),s._v("之后关闭服务器")])]),s._v(" "),a("li",[a("p",[s._v("一个redis服务器连接另一个redis服务器，并且向对方发送"),a("code",[s._v("sync")]),s._v("命令来开始一次复制操作时，若主服务器未执行或者不是刚刚执行完"),a("code",[s._v("bgsave操作，那么主服务器就会执行")]),s._v("bgsave`命令")])])]),s._v(" "),a("h2",{attrs:{id:"aof"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#aof"}},[s._v("#")]),s._v(" AOF")]),s._v(" "),a("p",[s._v("基础配置：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否开启 appendonly file 。no 表示不开启")]),s._v("\nappendonly "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# append only file 保存的文件名")]),s._v("\nappendfilename "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"appendonly.aof"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# no: 操作系统决定何时应该进行同步")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# always: 每个redis写命令都要同步写入硬盘")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# everysec: 每秒执行一次同步")]),s._v("\nappendfsync everysec\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# aof 文件重写配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为了解决AOF文件体积不断增大的问题")]),s._v("\nauto-aof-rewrite-percentage "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# AOF文件的体积比上次的体积大了100%")]),s._v("\nauto-aof-rewrite-min-size 64mb\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# AOF文件的体积大于64MB")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",[a("code",[s._v("appendfsync always")]),s._v("每次只写入一个命令，不断写入少量数据的做法可能引起写入放大问题。如果是固态硬盘可能会影响固态硬盘的使用寿命")])])])}),[],!1,null,null,null);n.default=e.exports}}]);